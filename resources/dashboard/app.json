[{"name":"app.R","content":"# Source global configuration and data loading explicitly\nsource(\"global.R\")\n\nlibrary(shiny)\nlibrary(bslib)\nlibrary(DT)\nlibrary(plotly)\nlibrary(heatmaply)\nlibrary(visNetwork)\n\n# --- Theme Definition ---\ngator_theme <- bs_theme(\n  version = 5,\n  primary = \"#0021A5\",    # UF Blue\n  secondary = \"#FA4616\",  # UF Orange\n  success = \"#22884c\",\n  warning = \"#ff9600\",\n  \"navbar-bg\" = \"#0021A5\"\n)\n\n# --- UI ---\nui <- page_navbar(\n  title = \"GIScience Journals\",\n  theme = gator_theme,\n  bg = \"#0021A5\", # Explicitly set navbar background to Gator Blue\n  fillable = FALSE, # Allow scrolling, prevent squashing\n  sidebar = NULL,\n  \n  header = tagList( # Content above/in header\n      tags$head(tags$style(HTML('\n            /* Custom Loading Screen */\n            #loading-screen {\n                position: fixed;\n                z-index: 9999;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-color: #ffffff;\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n                font-family: sans-serif;\n                transition: opacity 0.5s ease-out;\n            }\n            \n            .spinner {\n                border: 8px solid #f3f3f3;\n                border-top: 8px solid #FA4616;\n                border-radius: 50%;\n                width: 60px;\n                height: 60px;\n                animation: spin 1s linear infinite;\n                margin-bottom: 20px;\n            }\n            \n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n\n            /* Fix Dropdown Clipping in Cards */\n            .card, .card-body, .bslib-grid-item, .bslib-grid {\n                overflow: visible !important;\n            }\n            .selectize-dropdown {\n                z-index: 100000 !important;\n            }\n      '))),\n      tags$script(HTML('\n            $(document).on(\"shiny:connected\", function() {\n                $(\"#loading-screen\").css(\"opacity\", 0);\n                setTimeout(function() {\n                    $(\"#loading-screen\").remove();\n                }, 500);\n            });\n      ')),\n      div(id = \"loading-screen\",\n          div(class = \"spinner\"),\n          h3(\"Loading GIScience Dashboard...\", style = \"color: #0021A5;\")\n      )\n  ),\n\n  # --- Tab: Overview ---\n  nav_panel(\"Overview\", icon = icon(\"dashboard\"),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"GIScience Publication Trends Dashboard\", class = \"bg-primary text-white\"),\n        HTML(\n             \"<p>This dashboard accompanies the paper <a href='https://doi.org/10.1080/13658816.2024.2347306' target='_blank'><b>Assessing publication trends in selected GIScience journals<\/b><\/a> published in the <i>International Journal of Geographical Information Science<\/i> in 2024 with subsequent data updates. The goal is to help the GIScience community find suitable venues for publications, as well as to assess our field in terms of important concepts such as open access penetration and international collaboration.<\/p>\n              <p>For more details on methodology, limitations, and journal metrics, please see the <b>About<\/b> tab.<\/p>\"\n        )\n      )\n    ),\n    layout_columns(\n      col_widths = c(4, 4, 4),\n      uiOutput(\"totalJournalsBox\"),\n      uiOutput(\"totalArticlesBox\"),\n      uiOutput(\"oaShareBox\")\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Output Growth (Articles per Year)\", class = \"bg-primary text-white\"),\n        plotlyOutput(\"overviewPlot\", height = \"350px\"),\n        card_footer(\"Total number of articles published in the tracked journals.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Journal Metadata\", class = \"bg-primary text-white\"),\n        div(style = \"overflow-x: scroll;\", DTOutput(\"journalMetaTable\")),\n        card_footer(\n            HTML(\"Publishers: T&F = Taylor & Francis | Peer-review: D=double-blind; S=single-blind | OA: Open Access | The preprint column indicates whether depositing a preprint at article submission is allowed.\")\n        )\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Key Insights\", class = \"bg-success text-white\"),\n        uiOutput(\"dynamicInsights\")\n      )\n    )\n  ),\n\n  # --- Tab: Rankings ---\n  nav_panel(\"Rankings\", icon = icon(\"list-ol\"),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Journal Meta Ranking\", class = \"bg-warning text-dark\"),\n        layout_sidebar(\n           sidebar = sidebar(\n              width = 300, \n              selectInput(\"metaRankYear\", \"Select Year:\", choices = sort(unique(metrics_ranked$year), decreasing = TRUE)),\n              checkboxGroupInput(\"metaRankMetrics\", \"Select Metrics:\",\n                                   choices = c(\"Impact Factor\" = \"Rank_IF\", \n                                               \"CiteScore\" = \"Rank_CiteScore\", \n                                               \"SJR\" = \"Rank_SJR\", \n                                               \"SNIP\" = \"Rank_SNIP\",\n                                               \"5-Year IF\" = \"Rank_IF5y\",\n                                               \"Immediacy Index\" = \"Rank_Imm\",\n                                               \"Article Influence\" = \"Rank_Influ\",\n                                               \"Eigenfactor\" = \"Rank_Eigen\"),\n                                   selected = c(\"Rank_IF\", \"Rank_CiteScore\", \"Rank_SJR\", \"Rank_SNIP\"))\n           ),\n           plotlyOutput(\"metaRankPlot\", height = \"600px\")\n        ),\n        card_footer(\"The 'Meta Ranking' is calculated as the arithmetic mean of the ranks from the selected metrics. Points represent the mean rank; (error) bars show the range.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Journal Rankings Table\", class = \"bg-primary text-white\"),\n        div(style = \"margin-bottom: 15px;\",\n          selectInput(\"rankYear\", \"Table Year:\", choices = 2018:2025, selected = 2025, width = \"200px\")\n        ),\n        div(style=\"overflow-x: scroll;\", DTOutput(\"rankTable\"))\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Rank Evolution\", class = \"bg-primary text-white\"),\n        div(style = \"margin-bottom: 15px;\",\n            selectInput(\"rankMetric\", \"Metric Focus:\", \n                        choices = c(\"Impact Factor\" = \"IF\", \"SJR\" = \"SJR\", \"CiteScore\" = \"CiteScore\", \"SNIP\" = \"SNIP\",\n                                    \"5-Year Impact Factor\" = \"IF5y\", \"Immediacy Index\" = \"Imm\", \n                                    \"Article Influence\" = \"Influ\", \"Eigenfactor\" = \"Eigen\"),\n                        width = \"200px\")\n        ),\n        plotlyOutput(\"rankPlot\", height = \"500px\"),\n        card_footer(\"Cells are left empty if score is missing for a metric in a particular year.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Movers & Shakers\", class = \"bg-success text-white\"),\n        uiOutput(\"rankInsights\")\n      )\n    )\n  ),\n\n  # --- Tab: Trends ---\n  nav_panel(\"Trends\", icon = icon(\"chart-line\"),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Trend Settings\", class = \"bg-warning text-dark\"),\n        layout_columns(\n            col_widths = c(6, 6),\n            selectInput(\"trendJournals\", \"Select Journals to Compare:\", choices = NULL, multiple = TRUE, width = \"100%\"),\n            selectInput(\"trendMetric\", \"Select Metric for History:\",\n                          choices = c(\"Impact Factor\" = \"IF\", \"SJR\" = \"SJR\", \"CiteScore\" = \"CiteScore\", \"SNIP\" = \"SNIP\",\n                                      \"5-Year Impact Factor\" = \"IF5y\", \"Immediacy Index\" = \"Imm\", \n                                      \"Article Influence\" = \"Influ\", \"Eigenfactor\" = \"Eigen\"),\n                          selected = \"IF\", width = \"100%\")\n        )\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        uiOutput(\"trendBoxTitle\"), # Dynamic Header? No, card_header needs string/UI. We'll use textOutput inside header or refresh.\n        # Simpler: just use static header or standard UI logic\n        card_header(textOutput(\"trendBoxTitleText\")),\n        plotlyOutput(\"metricTrendPlot\"),\n        card_footer(\"Raw metric scores over time for selected journals.\")\n      )\n    ),\n    layout_columns(\n      col_widths = c(6, 6),\n      card(\n        card_header(\"Article Volume\", class = \"bg-light\"),\n        plotlyOutput(\"volumePlot\"),\n        card_footer(\"Total number of articles published in selected journals.\")\n      ),\n      card(\n        card_header(\"Open Access Adoption\", class = \"bg-light\"),\n        plotlyOutput(\"trendPlotOA\"),\n        card_footer(\"Total number of OA articles in selected journals.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Growth Leaders\", class = \"bg-success text-white\"),\n        uiOutput(\"trendInsights\")\n      )\n    )\n  ),\n\n  # --- Tab: Geography ---\n  nav_panel(\"Geography\", icon = icon(\"globe\"),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Filters\", class = \"bg-primary text-white\"),\n        checkboxGroupInput(\"geoYear\", \"Years:\", choices = NULL, inline = TRUE, width = \"100%\"),\n        selectInput(\"geoJournals\", \"Journals:\", choices = NULL, multiple = TRUE, width = \"100%\"),\n        card_footer(\"Filter by specific journals to see their combined global footprint. Contributing jurisdictions are counted once per article.\")\n      )\n    ),\n    layout_columns(\n      col_widths = c(8, 4),\n      card(\n        card_header(\"Global Distribution\", class = \"bg-primary text-white\"),\n        plotlyOutput(\"mapPlot\", height = \"520px\"),\n        card_footer(\"Number of articles in selected journals in selected years.\")\n      ),\n      card(\n        card_header(\"Top 10 Producing Jurisdictions\", class = \"bg-primary text-white\"),\n        plotlyOutput(\"countryBarPlot\", height = \"520px\"),\n        card_footer(\"Total number of articles involved.\")\n      )\n    )\n  ),\n\n  # --- Tab: Collaboration ---\n  nav_panel(\"Collaboration\", icon = icon(\"project-diagram\"),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"International Collaboration\", class = \"bg-primary text-white\"),\n        plotlyOutput(\"collabEvolPlot\", height = \"300px\"),\n        card_footer(\"Percentage of articles involving authors from at least two different jurisdictions.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Internationalization\", class = \"bg-primary text-white\"),\n        plotlyOutput(\"crossBorderPlot\", height = \"500px\"),\n        card_footer(\"Distribution of cross-border articles per journal vs global average.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Network Controls\", class = \"bg-warning text-dark\"),\n        sliderInput(\"minCollab\", \"Minimum Collaborations:\", min = 1, max = 20, value = 5, step = 1),\n        card_footer(\"Connections represent shared articles between jurisdictions.\")\n      )\n    ),\n    layout_columns(\n      col_widths = c(6, 6),\n      card(\n        card_header(\"International Collaboration Network\", class = \"bg-warning text-dark\"),\n        visNetworkOutput(\"collabNet\", height = \"600px\")\n      ),\n      card(\n        card_header(\"Key Collaboration Pairs\", class = \"bg-warning text-dark\"),\n        DTOutput(\"collabTable\", height = \"600px\")\n      )\n    )\n  ),\n\n  # --- Tab: Journal Insights ---\n  nav_panel(\"Journal Insights\", icon = icon(\"lightbulb\"),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Cost vs Impact: APC and Rankings\", class = \"bg-warning text-dark\"),\n        selectInput(\"apcRankMetric\", \"Select Ranking Metric:\", \n                      choices = c(\"Impact Factor\" = \"Rank_IF\", \n                                  \"CiteScore\" = \"Rank_CiteScore\", \n                                  \"SJR\" = \"Rank_SJR\", \n                                  \"SNIP\" = \"Rank_SNIP\",\n                                  \"5-Year IF\" = \"Rank_IF5y\",\n                                  \"Immediacy Index\" = \"Rank_Imm\",\n                                  \"Article Influence\" = \"Rank_Influ\",\n                                  \"Eigenfactor\" = \"Rank_Eigen\"),\n                      selected = \"Rank_SJR\"),\n        plotlyOutput(\"apcRankPlot\", height = \"500px\"),\n        card_footer(\"Note: Journals towards the origin (lower cost, better ranking) are often more desirable.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Open Access Adoption Rates\", class = \"bg-success text-white\"),\n        plotlyOutput(\"oaRealityPlot\", height = \"600px\"),\n        card_footer(\"Comparison of Journal OA% vs Field Average.\")\n      )\n    ),\n    layout_columns(\n      col_widths = 12,\n      card(\n        card_header(\"Publisher Market Share (Volume)\", class = \"bg-info text-white\"),\n        plotlyOutput(\"publisherPlot\", height = \"500px\"),\n        card_footer(\"Treemap of article volume by publisher.\")\n      )\n    )\n  ),\n\n  # --- Tab: About ---\n  nav_panel(\"About\", icon = icon(\"info-circle\"),\n    layout_columns(\n        col_widths = 12,\n        card(\n            card_header(\"About this Dashboard\", class = \"bg-primary text-white\"),\n            HTML(\n                 \"<p>This dashboard accompanies the paper <a href='https://doi.org/10.1080/13658816.2024.2347306' target='_blank'><b>Assessing publication trends in selected GIScience journals<\/b><\/a> published in the <i>International Journal of Geographical Information Science<\/i>. The goal is to help the GIScience community find suitable venues for publications and assess our field's evolution.<\/p>\n                 <p><b>A Note on Metrics:<\/b> While journal metrics play an embedded role in academic culture, often influencing promotion, tenure, and funding decisions, it is crucial to recognize their limitations. <b>Journal metrics are widely regarded as insufficient proxies for the quality and real-world impact of individual research<\/b>, especially when used in the context of individual research or authors. We encourage readers to engage with the principles of the <a href='https://sfdora.org/' target='_blank'>San Francisco Declaration on Research Assessment (DORA)<\/a>.<\/p>\n                 <p>Developed by the <a href='https://gatorlab.io' target='_blank'>GATOR Lab<\/a> (<b>G<\/b>eospatial <b>A<\/b>nalytics, <b>T<\/b>echnology and <b>O<\/b>pen <b>R<\/b>esearch) at the University of Florida. The initial Shiny dashboard was created by <a href='https://gatorlab.io/people/students/corcino.html' target='_blank'>Jorge Corcino<\/a>.<\/p>\"\n            )\n        ),\n        card(\n            card_header(\"Methodology\", class = \"bg-info text-white\"),\n            HTML(\n                \"<p>This dashboard considers citable items (articles, reviews) published in selected GIScience journals. Published articles and their metadata are sourced from <a href='https://dev.elsevier.com/sc_apis.html' target='_blank'>Scopus<\/a>. Journal metrics and other data are compiled in a manual-automatic way from various sources including JCR, SCImago and CWTS.<\/p>\"\n            )\n        ),\n        card(\n            card_header(\"Included journal evaluation metrics\", class = \"bg-success text-white\"),\n            HTML(\n                \"<ul>\n                  <li><b>Impact factor<\/b>: Measures the average number of citations received in a particular year by papers published in the journal during the two preceding years.<\/li>\n                  <li><b>CiteScore<\/b>: Calculates the average citations received per document published in the journal. It considers a four-year publication window, offering a broader scope than the IF.<\/li>\n                  <li><b>SNIP (Source normalized impact)<\/b>: Measures the contextual citation impact by weighting citations based on the total number of citations in a subject field. It provides a more field-specific understanding of citation impact..<\/li>\n                  <li><b>SJR (SCImago journal rank)<\/b>: Measures the scientific influence of the average article in a journal. It considers both the number of citations received by a journal and the importance of the journals where such citations come from.<\/li>\n                  <li><b>5-Year IF (5yrIF)<\/b>: Similar to the traditional IF, this metric averages the number of citations received in a particular year by papers published in the journal in the previous five years.<\/li>\n                  <li><b>Immediacy Index (Imm)<\/b>: Measures the average number of citations received in a given year by articles published in the same year. It helps gauge how quickly articles in a journal are cited upon publication.<\/li>\n                  <li><b>Article Influence Score (Influ)<\/b>: This metric reflects the average influence of a journalâ€™s articles over the first five years after publication. It is calculated by dividing the Eigenfactor Score by the number of articles in the journal, normalized as a fraction of all articles in all publications.<\/li>\n                  <li><b>Normalized Eigenfactor (Eigen)<\/b>: The calculation is based on the number of times articles from the journal published in the past five years have been cited in the current year. This metric adjusts for differences in citation practices across disciplines, making it possible to compare journals from different  fields.<\/li>\n                <\/ul>\"\n            )\n        ),\n        card(\n            card_header(\"Limitations\", class = \"bg-warning text-dark\"),\n            HTML(\n                \"<p>Here are a couple things to keep in mind.<\/p>\n                <ul>\n                  <li>Journal metrics are not representative of research quality.<\/li>\n                  <li>Not all GIScience research is distributed as journal articles.<\/li>\n                  <li>GIScience research is often distributed outside of the journals tracked in this dashboard.<\/li>\n                  <li>Authors may prefer to publish in languages other than English, which makes this dashboard skewed towards English-language publications and Western perspectives.<\/li>\n                  <li>The dashboard considers special administrative regions (e.g. Hong Kong, Macau) and other non-sovereign entities, therefore, the term jurisdiction is applied instead of country to be more inclusive.<\/li> \n                <\/ul>\"\n            )\n        )\n    )\n  )\n)\n\nserver <- function(input, output, session) {\n  \n  # DEBUG: Check data availability\n  # print(\"SERVER STARTED\")\n\n  # --- Overview Stats ---\n  output$totalJournalsBox <- renderUI({\n    value_box(\n        title = \"Journals Tracked\",\n        value = length(unique(journal_meta$ID)),\n        showcase = icon(\"book\"),\n        theme = \"primary\"\n    )\n  })\n  \n  output$totalArticlesBox <- renderUI({\n    total_arts <- if(nrow(articles_df) > 0) sum(articles_df$article, na.rm=TRUE) else 0\n    value_box(\n        title = \"Total Articles (2018-2024)\",\n        value = format(total_arts, big.mark=\",\"),\n        showcase = icon(\"file-alt\"),\n        theme = \"success\"\n    )\n  })\n  \n  output$oaShareBox <- renderUI({\n    total_arts <- if(nrow(articles_df) > 0) sum(articles_df$article, na.rm=TRUE) else 0\n    total_oa <- if(nrow(articles_df) > 0) sum(articles_df$open_access, na.rm=TRUE) else 0\n    pct <- if(total_arts > 0) round((total_oa / total_arts) * 100, 1) else 0\n    \n    value_box(\n        title = \"Open Access Share\",\n        value = paste0(pct, \"%\"),\n        showcase = icon(\"lock-open\"),\n        theme = \"warning\"\n    )\n  })\n  \n  # ... (Plots and Tables) ...\n  # Most original Render Logic is compatible with UI changes since IDs are preserved.\n  # We just need to make sure req() calls and data frames are available.\n\n  output$journalMetaTable <- renderDT({\n     req(journal_meta)\n     df_display <- journal_meta %>%\n       mutate(Journal = paste0(\"<a href='\", website, \"' target='_blank'>\", Journal, \"<\/a>\")) %>%\n       select(ID, Journal, Publisher, `Peer Review` = Peer.review, OA, Preprint, `APC (US$)` = `APC..US..`, Notes)\n     datatable(df_display, escape = FALSE, options = list(pageLength = 10, scrollX = TRUE), rownames = FALSE)\n  })\n\n  output$metaRankPlot <- renderPlotly({\n    req(input$metaRankYear, input$metaRankMetrics, nrow(metrics_ranked) > 0)\n    selected_metrics <- input$metaRankMetrics\n    available_cols <- intersect(selected_metrics, names(metrics_ranked))\n    if(length(available_cols) == 0) return(NULL)\n        \n    df_meta <- metrics_ranked %>%\n      filter(year == as.numeric(input$metaRankYear)) %>%\n      rowwise() %>%\n      mutate(\n        Mean_Rank = mean(c_across(all_of(available_cols)), na.rm = TRUE),\n        Min_Rank = min(c_across(all_of(available_cols)), na.rm = TRUE),\n        Max_Rank = max(c_across(all_of(available_cols)), na.rm = TRUE)\n      ) %>%\n      ungroup() %>%\n      filter(!is.na(Mean_Rank)) %>%\n      arrange(Mean_Rank)\n    \n    df_meta$ID <- factor(df_meta$ID, levels = rev(df_meta$ID))\n    \n    shapes <- list(\n      list(type = \"rect\", x0 = 0, x1 = 6.5, y0 = -1, y1 = nrow(df_meta), fillcolor = \"rgba(144, 238, 144, 0.3)\", line = list(width = 0)),\n      list(type = \"rect\", x0 = 6.5, x1 = 12.5, y0 = -1, y1 = nrow(df_meta), fillcolor = \"rgba(255, 255, 224, 0.3)\", line = list(width = 0)),\n      list(type = \"rect\", x0 = 12.5, x1 = 18.5, y0 = -1, y1 = nrow(df_meta), fillcolor = \"rgba(255, 218, 185, 0.3)\", line = list(width = 0)),\n      list(type = \"rect\", x0 = 18.5, x1 = 30, y0 = -1, y1 = nrow(df_meta), fillcolor = \"rgba(255, 182, 193, 0.3)\", line = list(width = 0))\n    )\n\n    plot_ly(df_meta, x = ~Mean_Rank, y = ~ID, type = 'scatter', mode = 'markers',\n            marker = list(color = 'black', size = 10),\n            error_x = list(type = 'data', symmetric = FALSE, array = ~Max_Rank - Mean_Rank, arrayminus = ~Mean_Rank - Min_Rank, color = 'black'),\n            hoverinfo = 'text',\n            text = ~paste(\"<b>\", ID, \"<\/b><br>Mean Rank:\", round(Mean_Rank, 1), \"<br>Range:\", Min_Rank, \"-\", Max_Rank)\n    ) %>% layout(\n        title = paste(\"Meta Ranking\", input$metaRankYear),\n        xaxis = list(title = \"Rank (Lower is Better)\", range = c(1, 24), gridcolor = 'lightgray'),\n        yaxis = list(title = \"\", tickfont=list(size=11)),\n        shapes = shapes,\n        margin = list(l = 100)\n    )\n  })\n\n  output$overviewPlot <- renderPlotly({\n    req(nrow(articles_df) > 0)\n    df <- articles_df %>% group_by(year) %>% summarise(count = sum(article), .groups='drop')\n    p <- ggplot(df, aes(x = year, y = count)) + geom_bar(stat = \"identity\", fill = \"#3c8dbc\") + theme_minimal() + labs(x = \"Year\", y = \"Total Articles\")\n    ggplotly(p)\n  })\n  \n  output$dynamicInsights <- renderUI({\n    req(exists(\"articles_df\"), exists(\"countries_df\"), exists(\"metrics_ranked\"))\n    top_country_data <- countries_df %>% group_by(country) %>% summarise(total = sum(num), .groups='drop') %>% arrange(desc(total)) %>% slice(1)\n    top_country_str <- paste0(\"The leading contributor is <b>\", top_country_data$country, \"<\/b> with \", format(top_country_data$total, big.mark=\",\"), \" articles.\")\n    \n    vol_by_year <- articles_df %>% filter(!is.na(year)) %>% group_by(year) %>% summarise(count = sum(article), .groups='drop')\n    start_vol <- vol_by_year$count[which.min(vol_by_year$year)]\n    end_vol <- vol_by_year$count[which.max(vol_by_year$year)]\n    growth_pct <- round(((end_vol - start_vol) / start_vol) * 100, 1)\n    trend_direction <- if(growth_pct > 0) \"increase\" else \"decrease\"\n    growth_str <- paste0(\"The field has seen a <b>\", abs(growth_pct), \"% \", trend_direction, \"<\/b> in publication volume since \", min(vol_by_year$year), \".\")\n    \n    HTML(paste(\"<ul>\", \"<li>\", top_country_str, \"<\/li>\", \"<li>\", growth_str, \"<\/li>\", \"<\/ul>\"))\n  })\n  \n  observeEvent(input$rankMetric, {\n    req(exists(\"metrics_ranked\"))\n    metric <- input$rankMetric\n    max_year <- max(metrics_ranked$year[!is.na(metrics_ranked[[metric]])], na.rm=TRUE)\n    available_years <- sort(unique(metrics_ranked$year[metrics_ranked$year <= max_year]), decreasing = TRUE)\n    updateSelectInput(session = getDefaultReactiveDomain(), \"rankYear\", choices = available_years, selected = available_years[1])\n  })\n\n  output$rankTable <- renderDT({\n    req(input$rankYear)\n    df <- metrics_ranked %>% filter(year == input$rankYear) %>% select(ID, IF, SJR, CiteScore, SNIP, IF5y, Imm, Influ, Eigen, Rank_IF, Rank_SJR, Rank_CiteScore, Rank_SNIP, Rank_IF5y, Rank_Imm, Rank_Influ, Rank_Eigen)\n    # Handle N/A logic can be done in JS or R, for brevity skipping detailed mutation here or keep it simple\n    datatable(df, options = list(pageLength = 15, dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')))\n  })\n  \n  output$rankInsights <- renderUI({\n    req(input$rankMetric, exists(\"metrics_ranked\"))\n    metric_col <- input$rankMetric\n    rank_col <- paste0(\"Rank_\", metric_col)\n    valid_data <- metrics_ranked %>% filter(!is.na(.data[[metric_col]]))\n    min_yr <- min(valid_data$year)\n    max_yr <- max(valid_data$year)\n    if(min_yr == max_yr) return(\"Not enough data history to calculate movers.\")\n    \n    start_ranks <- valid_data %>% filter(year == min_yr) %>% select(ID, start_rank = all_of(rank_col))\n    end_ranks <- valid_data %>% filter(year == max_yr) %>% select(ID, end_rank = all_of(rank_col))\n    comparison <- inner_join(start_ranks, end_ranks, by = \"ID\") %>% mutate(gain = start_rank - end_rank) %>% arrange(desc(gain))\n    \n    top_mover <- comparison[1,]\n    top_loser <- comparison[nrow(comparison),]\n    \n    if(top_mover$gain > 0) {\n      HTML(paste0(top_mover$ID, \" gained the most, climbing \", top_mover$gain, \" spots.\"))\n    } else {\n      \"Rankings have been relatively stable.\"\n    }\n  })\n  \n  output$rankPlot <- renderPlotly({\n    req(input$rankMetric)\n    metric_col <- input$rankMetric\n    rank_col <- paste0(\"Rank_\", metric_col)\n    valid_years <- metrics_ranked %>% filter(!is.na(.data[[metric_col]])) %>% pull(year) %>% unique()\n    max_year <- if(length(valid_years) > 0) max(valid_years) else 2022\n    top_ids <- metrics_ranked %>% filter(year == max_year) %>% arrange(.data[[rank_col]]) %>% slice(1:24) %>% pull(ID)\n    df <- metrics_ranked %>% filter(ID %in% top_ids, year <= max_year)\n    df$ID <- factor(df$ID, levels = rev(top_ids))\n    \n    p <- ggplot(df, aes(x = factor(year), y = ID)) +\n      geom_tile(aes(fill = .data[[rank_col]]), color = \"white\", size = 0.5) +\n      geom_text(aes(label = .data[[rank_col]]), color = \"white\", fontface = \"bold\", size = 4) +\n      scale_fill_viridis_c(option = \"viridis\", direction = 1, trans = \"reverse\", name = \"Rank\") +\n      theme_minimal() + labs(title = paste0(\"Rank Heatmap: \", input$rankMetric, \" (2018-\", max_year, \")\"), x = \"Year\", y = NULL) +\n      theme(panel.grid = element_blank(), legend.position = \"none\")\n    ggplotly(p, tooltip = c(\"y\", \"x\", \"label\"))\n  })\n  \n  observe({\n    req(exists(\"metrics_ranked\"))\n    latest_year <- max(metrics_ranked$year, na.rm=TRUE)\n    top_journals <- metrics_ranked %>% filter(year == latest_year) %>% arrange(desc(IF)) %>% slice(1:5) %>% pull(ID)\n    all_journals <- unique(metrics_ranked$ID)\n    updateSelectInput(session, \"trendJournals\", choices = all_journals, selected = top_journals)\n  })\n  \n  output$volumePlot <- renderPlotly({\n    req(input$trendJournals)\n    df <- articles_df %>% filter(journal %in% input$trendJournals) %>% group_by(year, journal) %>% summarise(articles = sum(article), .groups='drop')\n    p <- ggplot(df, aes(x = year, y = articles, fill = journal)) + geom_area(position = \"stack\", alpha = 0.8) + scale_fill_manual(values = journal_colors) + theme_minimal() + labs(title = \"Article Volume Evolution (Selected)\", x = \"Year\", y = \"Count\")\n    ggplotly(p)\n  })\n  \n  output$metricTrendPlot <- renderPlotly({\n    req(input$trendJournals, input$trendMetric)\n    metric_col <- input$trendMetric\n    df <- metrics_ranked %>% filter(ID %in% input$trendJournals, !is.na(.data[[metric_col]]))\n    min_yr <- min(df$year, na.rm=TRUE); max_yr <- max(df$year, na.rm=TRUE)\n    p <- ggplot(df, aes(x = year, y = .data[[metric_col]], color = ID, group = ID)) + geom_line(size = 1) + geom_point(size = 2) + scale_color_manual(values = journal_colors) + theme_minimal() + labs(title = paste0(metric_col, \" Trends\"), y = metric_col)\n    ggplotly(p)\n  })\n  \n  output$trendBoxTitleText <- renderText({\n    req(input$trendMetric, exists(\"metrics_ranked\"))\n    metric <- input$trendMetric\n    paste0(\"Historical Metric Trend: \", metric)\n  })\n  \n  output$trendPlotOA <- renderPlotly({\n    req(input$trendJournals)\n    df <- articles_df %>% filter(journal %in% input$trendJournals) %>% group_by(year, journal) %>% summarise(oa = sum(open_access), .groups='drop') %>% complete(year, journal, fill = list(oa = 0))\n    p <- ggplot(df, aes(x = year, y = oa, fill = journal)) + geom_area(position = 'stack', alpha = 0.8) + scale_fill_manual(values = journal_colors) + theme_minimal() + labs(title = \"Open Access Growth\", y = \"Open Access Articles\")\n    ggplotly(p)\n  })\n  \n  output$trendInsights <- renderUI({\n    req(input$trendJournals, exists(\"articles_df\"))\n    df <- articles_df %>% filter(journal %in% input$trendJournals, !is.na(year)) %>% group_by(journal, year) %>% summarise(count = sum(article), .groups='drop')\n    if(nrow(df) == 0) return(\"No data.\")\n    growth_stats <- df %>% group_by(journal) %>% summarise(start_val = count[which.min(year)], end_val = count[which.max(year)], .groups = 'drop') %>% mutate(growth_pct = ifelse(start_val > 0, (end_val - start_val)/start_val, 0)) %>% arrange(desc(growth_pct))\n    leader <- growth_stats[1,]\n    if(!is.na(leader$growth_pct) && leader$growth_pct > 0) {\n      HTML(paste0(leader$journal, \" is the fastest growing (\", round(leader$growth_pct * 100, 1), \"%).\"))\n    } else { \"No clear growth leader.\" }\n  })\n  \n  observe({\n    req(exists(\"countries_df\"))\n    if(nrow(countries_df) > 0) {\n        journals <- sort(unique(countries_df$journal))\n        updateSelectInput(session, \"geoJournals\", choices = journals, selected = journals)\n        unique_years <- sort(unique(countries_df$year), decreasing = TRUE)\n        updateCheckboxGroupInput(session, \"geoYear\", choices = unique_years, selected = unique_years)\n    }\n  })\n  \n  output$mapPlot <- renderPlotly({\n    req(input$geoJournals, input$geoYear)\n    df_filtered <- countries_df %>% filter(journal %in% input$geoJournals)\n    if(!is.null(input$geoYear)) df_filtered <- df_filtered %>% filter(year %in% as.numeric(input$geoYear))\n    df_map <- df_filtered %>% group_by(country) %>% summarise(count = sum(num), .groups='drop')\n    \n    plot_geo(df_map) %>%\n      add_trace(z = ~count, locations = ~country, locationmode = 'country names', color = ~count, colors = 'YlOrRd', marker = list(line = list(color = toRGB(\"white\"), width = 0.5)), text = ~paste(country, \"<br>Articles:\", count), hoverinfo = \"text\") %>%\n      layout(title = \"Global Distribution\", geo = list(showframe = FALSE, showcoastlines = TRUE, projection = list(type = 'eckert4')))\n  })\n  \n  output$countryBarPlot <- renderPlotly({\n    req(input$geoJournals, input$geoYear)\n    df_filtered <- countries_df %>% filter(journal %in% input$geoJournals)\n    if(!is.null(input$geoYear)) df_filtered <- df_filtered %>% filter(year %in% as.numeric(input$geoYear))\n    df_bar <- df_filtered %>% group_by(country) %>% summarise(count = sum(num), .groups='drop') %>% arrange(desc(count)) %>% slice(1:10)\n    \n    p <- ggplot(df_bar, aes(x = reorder(country, count), y = count)) + geom_bar(stat = \"identity\", fill = \"#00a65a\") + coord_flip() + theme_minimal() + labs(x = NULL, y = \"Total Articles\")\n    ggplotly(p)\n  })\n\n  # --- Collaboration Logic ---\n  output$collabEvolPlot <- renderPlotly({\n    req(nrow(articles_df) > 0)\n    df_agg <- articles_df %>% filter(!is.na(year), year >= 2018) %>% group_by(year) %>% summarise(total_articles = sum(as.numeric(article), na.rm=TRUE), multi_cnt = sum(as.numeric(multi_country), na.rm=TRUE), .groups = 'drop') %>% mutate(pct_collab = (multi_cnt / total_articles) * 100)\n    \n    # Range\n    df_range <- articles_df %>% filter(!is.na(year), year >= 2018) %>% group_by(year, journal) %>% summarise(total = sum(article), multi = sum(multi_country), .groups='drop') %>% mutate(pct = (multi/total)*100) %>% group_by(year) %>% summarise(min_pct = min(pct, na.rm=TRUE), max_pct = max(pct, na.rm=TRUE), .groups='drop')\n    \n    p <- plot_ly() %>%\n      add_ribbons(data = df_range, x = ~year, ymin = ~min_pct, ymax = ~max_pct, fillcolor = 'rgba(200, 200, 200, 0.3)', line = list(color = 'transparent'), name = \"Range\", showlegend = T) %>%\n      add_trace(data = df_agg, x = ~year, y = ~pct_collab, type = 'scatter', mode = 'lines+markers', line = list(color = '#0021A5', width = 3), marker = list(color = '#FA4616', size = 10), name = \"Global Average\", hoverinfo = 'text', text = ~paste(\"<b>Global Average<\/b><br>Year:\", year, \"<br>Int. Collab:\", round(pct_collab, 1), \"%\")) %>%\n      layout(xaxis = list(title = \"Year\"), yaxis = list(title = \"% International Collaboration\", range=c(0,100)))\n    p\n  })\n\n  reactive_graph_data <- reactive({\n    req(exists(\"collab_df\"), input$minCollab)\n    edges_agg <- collab_df %>% group_by(country_1, country_2) %>% summarise(weight = sum(num), .groups='drop') %>% filter(weight >= input$minCollab)\n    if(nrow(edges_agg) == 0) return(NULL)\n    g <- graph_from_data_frame(edges_agg, directed = FALSE)\n    deg <- degree(g, mode = \"all\")\n    \n    country_stats <- countries_df %>% group_by(country) %>% summarise(articles = sum(num), .groups='drop')\n    world_info <- continents_df\n    \n    summary_df <- data.frame(Country = V(g)$name, Partners = as.numeric(deg)) %>%\n        left_join(country_stats, by = c(\"Country\" = \"country\")) %>%\n        left_join(world_info, by = c(\"Country\" = \"admin\")) %>%\n        mutate(Continent = ifelse(is.na(continent), \"Other\", continent), articles = ifelse(is.na(articles), 1, articles))\n    list(graph = g, summary = summary_df)\n  })\n\n  output$collabNet <- renderVisNetwork({\n    data <- reactive_graph_data()\n    req(data)\n    g_full <- data$graph\n    # ... (VisNetwork standard logic - reusing simplified version to fix issues) ...\n    # Wait, the previous visNetwork logic was GOOD. I should keep it.\n    \n    nodes_df <- data.frame(id = V(g_full)$name, label = V(g_full)$name, group = data$summary$Continent, value = data$summary$articles)\n    edges_df <- as_data_frame(g_full, what = \"edges\"); edges_df$value <- edges_df$weight\n    \n    visNetwork(nodes_df, edges_df) %>%\n      visPhysics(solver = \"forceAtlas2Based\", forceAtlas2Based = list(gravitationalConstant = -50, centralGravity = 0.01, springLength = 100, springConstant = 0.08, damping = 1), minVelocity = 0.75, stabilization = list(enabled = TRUE, iterations = 200)) %>%\n      visLegend(width = 0.1, position = \"right\", main = \"Continent\", useGroups = TRUE) %>%\n      visNodes(scaling = list(min = 10, max = 50)) %>%\n      visEdges(scaling = list(min = 1, max = 10), color = list(color = \"lightgrey\", highlight = \"#FA4616\"))\n  })\n\n  output$collabTable <- renderDT({\n    data <- reactive_graph_data()\n    req(data)\n    edges <- as_data_frame(data$graph, what = \"edges\") %>% arrange(desc(weight)) %>% select(from, to, weight)\n    datatable(edges, options = list(pageLength = 15))\n  })\n  \n  output$crossBorderPlot <- renderPlotly({\n    req(nrow(articles_df) > 0)\n    df_cross <- articles_df %>% group_by(journal) %>% summarise(total = sum(article), cross = sum(multi_country), .groups='drop') %>% mutate(pct = (cross/total)*100) %>% mutate(journal = reorder(journal, pct))\n    avg <- sum(df_cross$cross)/sum(df_cross$total)*100\n    p <- ggplot(df_cross, aes(x = pct, y = journal, color = journal)) + geom_segment(aes(x = avg, xend = pct, y = journal, yend = journal)) + geom_point(size=4) + geom_vline(xintercept = avg, color=\"gray\", linetype=\"dashed\") + scale_color_manual(values = journal_colors) + theme_minimal() + theme(legend.position=\"none\")\n    ggplotly(p)\n  })\n  \n  output$apcRankPlot <- renderPlotly({\n    req(input$apcRankMetric, exists(\"journal_meta\"), nrow(metrics_ranked) > 0)\n    max_year <- max(metrics_ranked$year)\n    df_rank <- metrics_ranked %>% filter(year == max_year) %>% select(ID, Rank = all_of(input$apcRankMetric))\n    df_apc <- journal_meta %>% select(ID, APC = `APC..US..`) %>% mutate(APC = as.numeric(gsub(\"[^0-9.]\", \"\", APC)))\n    df_plot <- inner_join(df_rank, df_apc, by=\"ID\")\n    p <- ggplot(df_plot, aes(x = Rank, y = APC, color = ID, text = paste(ID))) + geom_point(size=4) + scale_color_manual(values = journal_colors) + theme_minimal() + theme(legend.position=\"none\")\n    ggplotly(p)\n  })\n  \n  output$oaRealityPlot <- renderPlotly({\n    req(nrow(articles_df) > 0)\n    global_pct <- sum(articles_df$open_access)/sum(articles_df$article)*100\n    df_oa <- articles_df %>% group_by(journal) %>% summarise(pct = sum(open_access)/sum(article)*100) %>% mutate(journal = reorder(journal, pct))\n    p <- ggplot(df_oa, aes(x = pct, y = journal, color = journal)) + geom_segment(aes(x = global_pct, xend = pct, y = journal, yend = journal)) + geom_point(size=4) + geom_vline(xintercept = global_pct, color=\"gray\", linetype=\"dashed\") + scale_color_manual(values = journal_colors) + theme_minimal() + theme(legend.position=\"none\")\n    ggplotly(p)\n  })\n  \n  output$publisherPlot <- renderPlotly({\n    req(exists(\"journal_meta\"), nrow(articles_df) > 0)\n    df_vol <- articles_df %>% group_by(journal) %>% summarise(volume = sum(article))\n    df_tree <- df_vol %>% \n               left_join(journal_meta, by = c(\"journal\" = \"ID\")) %>% \n               filter(!is.na(Publisher) & Publisher != \"\") %>% \n               group_by(Publisher) %>% \n               summarise(\n                   count = sum(volume), \n                   journals = paste(unique(journal), collapse=\", \"),\n                   .groups='drop'\n               ) %>%\n               mutate(parents = \"\") # Root nodes have empty parent\n    \n    plot_ly(\n      df_tree,\n      labels = ~Publisher,\n      parents = ~parents,\n      values = ~count,\n      type = 'treemap',\n      textinfo = \"label+value+percent parent\",\n      hovertemplate = \"<b>%{label}<\/b><br>Articles: %{value}<br>Journals: %{customdata}<extra><\/extra>\",\n      customdata = ~journals\n    ) %>% layout(title = \"Article Volume by Publisher\")\n  })\n\n}\n\n\nshinyApp(ui = ui, server = server)\n","type":"text"},{"name":"global.R","content":"\nlibrary(shiny)\nlibrary(bslib)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(readr)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(munsell) # Explicitly load to fix missing dependency\nlibrary(scales)\nlibrary(plotly)\nlibrary(visNetwork)\nlibrary(heatmaply)\nlibrary(DT)\n\n# --- Load Data (RDS) ---\n# Function to download data if not present in VFS\nensure_file <- function(filename) {\n  if (!file.exists(filename)) {\n    message(paste(\"Downloading\", filename, \"...\"))\n    # In Shinylive, this URL is relative to the index.html\n    # We use root-relative path to access Quarto static files directory\n    url <- paste0(\"/files/dashboard_data/\", filename)\n    download.file(url, filename, mode = \"wb\")\n  }\n  return(filename)\n}\n\narticles_df <- readRDS(ensure_file(\"articles.rds\"))\ncountries_df <- readRDS(ensure_file(\"countries.rds\"))\ncollab_df <- readRDS(ensure_file(\"collab.rds\"))\n\n# Metrics\nif (!file.exists(\"metrics.rds\")) {\n    # Try to download\n    tryCatch({\n        download.file(\"/files/dashboard_data/metrics.rds\", \"metrics.rds\", mode = \"wb\")\n    }, error = function(e) { message(\"No metrics.rds found\") })\n}\nmetrics_ranked <- if(file.exists(\"metrics.rds\")) readRDS(\"metrics.rds\") else data.frame(ID=character(), year=integer())\n\ncontinents_df <- readRDS(ensure_file(\"continents.rds\"))\n\n# Metadata CSV\nif (!file.exists(\"overview.csv\")) {\n    download.file(\"/files/dashboard_data/overview.csv\", \"overview.csv\", mode = \"wb\")\n}\njournal_meta <- read.csv(\"overview.csv\", as.is=TRUE)\n\n# --- Configuration ---\njournal_names <- sort(unique(c(articles_df$journal, metrics_ranked$ID)))\ncolor_palette <- c(\n    \"#1f77b4\", \"#ff7f0e\", \"#2ca02c\", \"#d62728\", \"#9467bd\",\n    \"#8c564b\", \"#e377c2\", \"#7f7f7f\", \"#bcbd22\", \"#17becf\",\n    \"#aec7e8\", \"#ffbb78\", \"#98df8a\", \"#ff9896\", \"#c5b0d5\",\n    \"#c49c94\", \"#f7b6d2\", \"#c7c7c7\", \"#dbdb8d\", \"#9edae5\",\n    \"#393b79\", \"#637939\", \"#8c6d31\", \"#843c39\"\n)\nif (length(journal_names) > length(color_palette)) {\n  color_palette <- colorRampPalette(color_palette)(length(journal_names))\n} else {\n  color_palette <- color_palette[1:length(journal_names)]\n}\njournal_colors <- setNames(color_palette, journal_names)\n\n","type":"text"}]
